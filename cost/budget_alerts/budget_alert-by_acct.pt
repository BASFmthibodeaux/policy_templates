name "Budget Alerts by Cloud Account"
rs_pt_ver 20180301
type "policy"
short_description "Create a Monthly Budget Alert for a Cloud Account. See the [README](https://github.com/rightscale/policy_templates/tree/master/cost/budget_alerts/) and [docs.rightscale.com/policies](http://docs.rightscale.com/policies/) to learn more."
long_description "Version: 0.1"
severity "medium"
category "Cost"

parameter "param_monthly_budget" do
  label "Monthly Budget"
  type "number"
end 

parameter "param_account_id" do 
  label "Cloud Account ID"
  description "Provide the ID of the target Cloud Account"
  type "string"
end 

parameter "param_type" do 
  label "Budget Alert Type"
  type "string"
  allowed_values "Actual Spend","Forecasted Spend"
  description "Actual Spend alerts are based off incurred costs. Forecasted Spend alerts are based off monthly runrates."
  default "Actual Spend"
end 

parameter "param_cost_metric" do
  type "string"
  label "Cost Metric"
  allowed_values "Unamortized Unblended","Amortized Unblended","Unamortized Blended","Amortized Blended"
  default "Unamortized Unblended"
  description "Select the cost metric for your report.  See the README file for more details"
end

parameter "param_email" do
  label "Email addresses of the recipients you wish to notify"
  type "list"
end

auth "auth_rs", type: "rightscale"

datasource "ds_billing_centers" do
  request do
    auth $auth_rs
    host rs_optima_host
    path join(["/analytics/orgs/",rs_org_id,"/billing_centers"])
    header "Api-Version", "1.0"
    header "User-Agent", "RS Policies"
    query "view", "allocation_table"
  end
  result do
    encoding "json"
    collect jmes_path(response,"[*]") do
      field "href", jmes_path(col_item,"href")
      field "id", jmes_path(col_item,"id")
      field "name", jmes_path(col_item,"name")
      field "parent_id", jmes_path(col_item,"parent_id")
      field "ancestor_ids", jmes_path(col_item,"ancestor_ids")
      field "allocation_table", jmes_path(col_item,"allocation_table")
    end
  end
end

datasource "ds_top_level_billing_centers" do
  run_script $js_top_level_bc, $ds_billing_centers
end

script "js_top_level_bc", type: "javascript" do
  parameters "billing_centers"
  result "filtered_billing_centers"
  code <<-EOS
  var filtered_billing_centers =
    _.reject(billing_centers, function(bc){ return bc.parent_id != null });
EOS
end

datasource "ds_account_cost" do
  request do
    run_script $costs_request, rs_org_id, $param_cost_metric, vals($ds_top_level_billing_centers, "id"), $param_account_id
  end
  result do
    encoding "json"
    collect jmes_path(response,"rows[*]") do
      field "amortized_unblended_costs", jmes_path(col_item,"metrics.cost_amortized_unblended_adj")
      field "amortized_blended_costs", jmes_path(col_item,"metrics.cost_amortized_blended_adj")
      field "nonamortized_unblended_costs", jmes_path(col_item,"metrics.cost_nonamortized_unblended_adj")
      field "nonamortized_blended_costs", jmes_path(col_item,"metrics.cost_nonamortized_blended_adj")
    end
  end
end

script "costs_request", type: "javascript" do
  parameters "org","param_cost_metric","bc_ids","account_id"
  result "request"
  code <<-EOS
    var cost_metric = {
      "Unamortized Unblended":"cost_nonamortized_unblended_adj",
      "Amortized Unblended":"cost_amortized_unblended_adj",
      "Unamortized Blended": "cost_nonamortized_blended_adj",
      "Amortized Blended":"cost_amortized_blended_adj"
    }
    var date = new Date();
    var year = date.getUTCFullYear();
    var month = (2 + date.getUTCMonth())
    
    if (month == 1){ 
      var lmonth = 12;
      var lyear = year-1 ;
    } else {
      var lmonth = month-1;
      var lyear = year ;
    }
    
    mo = month.toString().length > 1 ? month : '0' + month;
    lmo = lmonth.toString().length > 1 ? lmonth : '0' + lmonth;


    var next_month = year + "-" + mo
    var current_month = lyear + "-" + lmo

    var request = {
      auth: "auth_rs",
      host: "optima.rightscale.com",
      verb: "POST",
      path: "/bill-analysis/orgs/" + org + "/costs/aggregated",
      body_fields: {
        "dimensions": ["vendor_account","billing_center_id"],
        "granularity": "month",
        "start_at": current_month,
        "end_at": next_month,
        "metrics": [cost_metric[param_cost_metric]],
        "billing_center_ids": bc_ids,
        "filter": {
          "dimension": "vendor_account",
          "type": "equal",
          "value": account_id
        }
      },
      headers: {
        "User-Agent": "RS Policies",
        "Api-Version": "1.0"
      }
    } 
  EOS
end

datasource "ds_formatted_cost" do
  run_script $js_bc_costs, $ds_account_cost, $param_cost_metric, $param_account_id
end

script "js_bc_costs", type: "javascript" do
  parameters "account_cost", "param_cost_metric", "param_account_id"
  result "costs"
  code <<-EOS
  var costs = [];

  var cost_type = {
      "Unamortized Unblended":"nonamortized_unblended_costs",
      "Amortized Unblended":"amortized_unblended_costs",
      "Unamortized Blended": "nonamortized_blended_costs",
      "Amortized Blended":"amortized_blended_costs"
  }
  
  var type = cost_type[param_cost_metric];
  console.log(type)
  var cost = account_cost[0][type];
  console.log(cost)

  costs.push({
      account_id: param_account_id,
      total: cost,
  })

  console.log(costs)
EOS
end 

datasource "filtered_target" do 
  run_script $js_filter_target, $ds_formatted_cost, $param_account_id, $param_monthly_budget, $param_type
end 

script "js_filter_target", type: "javascript" do 
  parameters "account_cost", "param_account_id", "param_monthly_budget", "param_type"
  result "target"
  code <<-EOS
  var target = [] ;
  var date = new Date();
  var month = date.getUTCMonth()+1;
  var day = date.getUTCDate();

  console.log(date)
  console.log(month)
  console.log(day)

  if (month == 1){ var numdays = 31 ;}
  if (month == 2){ var numdays = 31 ;}
  if (month == 3){ var numdays = 31 ;}
  if (month == 4){ var numdays = 30 ;}
  if (month == 5){ var numdays = 31 ;}
  if (month == 6){ var numdays = 30 ;}
  if (month == 7){ var numdays = 31 ;}
  if (month == 8){ var numdays = 31 ;}
  if (month == 9){ var numdays = 30 ;}
  if (month == 10){ var numdays = 31 ;}
  if (month == 11){ var numdays = 30 ;}
  if (month == 12){ var numdays = 31 ;}

  var monthcomplete = day / numdays ;

  console.log(monthcomplete)

  var runrate = account_cost[0]["total"] / monthcomplete ;
  if (param_type === "Forecasted Spend"){
    target.push({
      account_id: param_account_id,
      actual: (Math.round(account_cost[0]["total"] * 100) / 100).toString(10),
      type: "Forecasted Spend",
      runrate: (Math.round(runrate * 100) / 100).toString(10),
      budget: param_monthly_budget,
      total: runrate
    })
  } else {
    target.push({
      account_id: param_account_id,
      actual: (Math.round(account_cost[0]["total"] * 100) / 100).toString(10),
      type: "Actual Spend",
      runrate: (Math.round(runrate * 100) / 100).toString(10),
      budget: param_monthly_budget,
      total: account_cost[0]["total"]
    })
  }  
EOS
end 

escalation "esc_budget_alert" do
  email $param_email
end

policy "budget_alert" do
  validate_each $filtered_target do
    summary_template "Budget Exceeded"
    detail_template <<-EOS
# Budget Exceeded

| Cloud Account ID | Budget Alert Type | Budget | Current Monthly Spend | Monthly Runrate | 
| ---------------- | ----------------- | ------ | --------------------- | --------------- | 
{{ range data -}}
| {{ .account_id }} | {{.type}} | {{.budget}} | {{.actual}} | {{.runrate}} |
{{ end -}}

EOS
    escalate $esc_budget_alert
    check lt(val(item,"total"),$param_monthly_budget)
  end
end